<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registre Non-ConformitÃ©s | GRETA GIP-FIPAN</title>
  <link rel="stylesheet" href="../css/style.css">
  
  <link rel="stylesheet" href="../assets/core/core.css">
</head>
<body>
  <header class="core-header">
  <div class="core-container core-header-top">
    <div class="core-branding">
      <img src="../images/logo-republique.png" alt="RÃ©publique FranÃ§aise" class="core-logo-rf">
      <div class="core-brand-text">
        <p class="core-kicker">GRETA GIP-FIPAN â€¢ AcadÃ©mie de Nice</p>
        <h1>ğŸ“š Plateforme PMS</h1>
      </div>
      <img src="../images/logoFORPROPaca.png" alt="FORPRO PACA" class="core-logo-forpro">
    </div>
  </div>
  <nav class="core-main-nav" aria-label="Navigation principale">
    <div class="core-container core-nav-wrap">
      <a href="/plateforme-pms2/" class="core-nav-link">ğŸ  Hub</a>
      <a href="/plateforme-pms2/cours-pms.html" class="core-nav-link">ğŸ“˜ Formation</a>
      <a href="/plateforme-pms2/outils-modeles.html" class="core-nav-link is-active">ğŸ§° Outils</a>
      <a href="/plateforme-pms2/documents-pms.html" class="core-nav-link">ğŸ“‚ Ressources</a>
    </div>
  </nav>
</header>
  <a href="../index.html" class="back-home">â† Retour au hub d'accueil</a>


  <main>
    
    <a href="outils-modeles.html" class="back-home">â† Retour aux outils</a>
    
    <div class="intro-card">
      <h2>ğŸš¨ Registre des Non-ConformitÃ©s PMS</h2>
      <p>
        Outil de traÃ§abilitÃ© rÃ©glementaire pour l'enregistrement et le suivi des non-conformitÃ©s 
        dÃ©tectÃ©es dans le cadre du Plan de MaÃ®trise Sanitaire.
      </p>
      <div class="alert-info">
        <p><strong>âš–ï¸ Obligation rÃ©glementaire :</strong> Le registre des NC doit Ãªtre tenu Ã  jour en permanence et conservÃ© 1 an minimum. Il peut Ãªtre consultÃ© lors d'un contrÃ´le DDPP.</p>
      </div>
    </div>

    <!-- Formulaire d'enregistrement NC -->
    <div class="nc-form">
      <h2>ğŸ“ DÃ©clarer une Non-ConformitÃ©</h2>
      
      <form id="ncForm">
        
        <div class="form-row">
          <div class="form-group">
            <label for="ncDate">Date de dÃ©tection *</label>
            <input type="date" id="ncDate" required>
          </div>
          
          <div class="form-group">
            <label for="ncType">Type de NC *</label>
            <select id="ncType" required>
              <option value="">-- SÃ©lectionnez --</option>
              <option value="TempÃ©rature">â„ï¸ TempÃ©rature hors limites</option>
              <option value="HygiÃ¨ne">ğŸ§¼ HygiÃ¨ne personnel/locaux</option>
              <option value="TraÃ§abilitÃ©">ğŸ“¦ TraÃ§abilitÃ©</option>
              <option value="RÃ©ception">ğŸšš RÃ©ception marchandises</option>
              <option value="Nettoyage">ğŸ§½ Nettoyage/DÃ©sinfection</option>
              <option value="DLC">ğŸ“… DLC dÃ©passÃ©e</option>
              <option value="AllergÃ¨ne">ğŸ¥œ AllergÃ¨ne</option>
              <option value="Nuisible">ğŸ€ Nuisible</option>
              <option value="Autre">â“ Autre</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="ncGravite">GravitÃ© *</label>
            <select id="ncGravite" required>
              <option value="">-- SÃ©lectionnez --</option>
              <option value="Critique">ğŸ”´ Critique (danger immÃ©diat)</option>
              <option value="Majeure">ğŸŸ  Majeure (risque sanitaire)</option>
              <option value="Mineure">ğŸŸ¡ Mineure (amÃ©lioration)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="ncDescription">Description de la NC *</label>
          <textarea id="ncDescription" rows="3" required
                    placeholder="DÃ©crivez prÃ©cisÃ©ment la non-conformitÃ© constatÃ©e..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ncCause">Cause identifiÃ©e</label>
            <input type="text" id="ncCause" placeholder="Ex: Panne chambre froide, Formation insuffisante...">
          </div>
          
          <div class="form-group">
            <label for="ncDetecteur">DÃ©tectÃ© par *</label>
            <input type="text" id="ncDetecteur" required placeholder="Nom du dÃ©tecteur">
          </div>
        </div>

        <div class="form-group">
          <label for="ncActionImmediate">Action immÃ©diate mise en Å“uvre *</label>
          <textarea id="ncActionImmediate" rows="2" required
                    placeholder="Ex: Produits isolÃ©s et Ã©liminÃ©s, TempÃ©rature rÃ©tablie, Nettoyage immÃ©diat..."></textarea>
        </div>

        <div class="form-group">
          <label for="ncActionCorrective">Action corrective Ã  mettre en Å“uvre *</label>
          <textarea id="ncActionCorrective" rows="2" required
                    placeholder="Ex: RÃ©vision procÃ©dure, Formation personnel, VÃ©rification Ã©quipement..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ncResponsable">Responsable du suivi *</label>
            <input type="text" id="ncResponsable" required placeholder="Nom du responsable">
          </div>
          
          <div class="form-group">
            <label for="ncEcheance">Ã‰chÃ©ance de clÃ´ture *</label>
            <input type="date" id="ncEcheance" required>
          </div>
        </div>

        <div>
          <button type="submit" class="btn btn-primary">
            âœ… Enregistrer la NC
          </button>
        </div>

      </form>
    </div>

    <!-- Liste des NC enregistrÃ©es -->
    <div class="nc-list">
      <div>
        <h2>ğŸ“‹ Non-ConformitÃ©s EnregistrÃ©es</h2>
        <div>
          <button onclick="filtrerNC('toutes')" class="btn btn-secondary">Toutes</button>
          <button onclick="filtrerNC('ouvertes')" class="btn btn-secondary">Ouvertes</button>
          <button onclick="filtrerNC('closes')" class="btn btn-secondary">ClÃ´turÃ©es</button>
          <button onclick="exporterNC()" class="btn btn-download">ğŸ“¥ Exporter</button>
        </div>
      </div>
      
      <div id="ncContainer">
        <p>
          Aucune non-conformitÃ© enregistrÃ©e. Utilisez le formulaire ci-dessus pour dÃ©clarer une NC.
        </p>
      </div>
    </div>

  </main>

  <footer class="core-footer">
  <div class="core-container core-footer-content">
    <div class="core-footer-logos">
      <img src="../images/logo-republique.png" alt="RÃ©publique FranÃ§aise" class="core-footer-logo">
      <img src="../images/logoFORPROPaca.png" alt="FORPRO PACA" class="core-footer-logo">
    </div>
    <div class="core-footer-info">
      <p><strong>CrÃ©Ã© par BenoÃ®t Deflandre</strong></p>
      <p>GRETA du Var / GIP FIPAN â€¢ AcadÃ©mie de Nice</p>
      <p><a href="mailto:benoit.deflandre@ac-nice.fr">benoit.deflandre@ac-nice.fr</a></p>
      <p class="core-version">Plateforme PMS V18.0 â€¢ Janvier 2025</p>
    </div>
  </div>
</footer>

  <script>
    // RÃ©cupÃ©rer les NC depuis localStorage
    function getNC() {
      try {
        return JSON.parse(localStorage.getItem('registreNC') || '[]');
      } catch (e) {
        return [];
      }
    }

    // Sauvegarder les NC
    function saveNC(ncList) {
      try {
        localStorage.setItem('registreNC', JSON.stringify(ncList));
      } catch (e) {
        console.error('Erreur sauvegarde:', e);
      }
    }

    // GÃ©nÃ©rer numÃ©ro NC
    function generateNCNumber() {
      const ncList = getNC();
      const year = new Date().getFullYear();
      const count = ncList.filter(nc => nc.numero.startsWith(`NC-${year}`)).length + 1;
      return `NC-${year}-${String(count).padStart(3, '0')}`;
    }

    // Afficher les NC
    function afficherNC(filter = 'toutes') {
      const ncList = getNC();
      const container = document.getElementById('ncContainer');
      
      let filtered = ncList;
      if (filter === 'ouvertes') {
        filtered = ncList.filter(nc => nc.statut === 'Ouverte');
      } else if (filter === 'closes') {
        filtered = ncList.filter(nc => nc.statut === 'ClÃ´turÃ©e');
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<p>Aucune non-conformitÃ© Ã  afficher.</p>';
        return;
      }
      
      container.innerHTML = filtered.map(nc => `
        <div class="nc-item ${nc.statut === 'ClÃ´turÃ©e' ? 'resolved' : ''}">
          <div class="nc-header">
            <div class="nc-number">${nc.numero}</div>
            <span class="nc-status ${nc.statut === 'ClÃ´turÃ©e' ? 'closed' : 'open'}">
              ${nc.statut === 'ClÃ´turÃ©e' ? 'âœ… ClÃ´turÃ©e' : 'ğŸ”´ Ouverte'}
            </span>
          </div>
          
          <div class="nc-details">
            <div class="nc-detail-item"><strong>Date :</strong> ${nc.date}</div>
            <div class="nc-detail-item"><strong>Type :</strong> ${nc.type}</div>
            <div class="nc-detail-item"><strong>GravitÃ© :</strong> ${nc.gravite}</div>
            <div class="nc-detail-item"><strong>Description :</strong> ${nc.description}</div>
            <div class="nc-detail-item"><strong>Cause :</strong> ${nc.cause || '-'}</div>
            <div class="nc-detail-item"><strong>Action immÃ©diate :</strong> ${nc.actionImmediate}</div>
            <div class="nc-detail-item"><strong>Action corrective :</strong> ${nc.actionCorrective}</div>
            <div class="nc-detail-item"><strong>Responsable :</strong> ${nc.responsable}</div>
            <div class="nc-detail-item"><strong>Ã‰chÃ©ance :</strong> ${nc.echeance}</div>
            <div class="nc-detail-item"><strong>DÃ©tectÃ© par :</strong> ${nc.detecteur}</div>
          </div>
          
          ${nc.statut === 'Ouverte' ? `
            <button onclick="cloturerNC('${nc.numero}')" class="btn btn-primary">
              âœ… ClÃ´turer cette NC
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    // Soumettre le formulaire
    document.getElementById('ncForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const nc = {
        numero: generateNCNumber(),
        date: document.getElementById('ncDate').value,
        type: document.getElementById('ncType').value,
        gravite: document.getElementById('ncGravite').value,
        description: document.getElementById('ncDescription').value,
        cause: document.getElementById('ncCause').value,
        detecteur: document.getElementById('ncDetecteur').value,
        actionImmediate: document.getElementById('ncActionImmediate').value,
        actionCorrective: document.getElementById('ncActionCorrective').value,
        responsable: document.getElementById('ncResponsable').value,
        echeance: document.getElementById('ncEcheance').value,
        statut: 'Ouverte',
        dateEnregistrement: new Date().toISOString()
      };
      
      const ncList = getNC();
      ncList.unshift(nc);
      saveNC(ncList);
      
      alert(`âœ… Non-conformitÃ© ${nc.numero} enregistrÃ©e avec succÃ¨s`);
      this.reset();
      afficherNC();
      
      document.getElementById('ncContainer').scrollIntoView({ behavior: 'smooth' });
    });

    // ClÃ´turer une NC
    function cloturerNC(numero) {
      if (!confirm(`Confirmer la clÃ´ture de la NC ${numero} ?`)) return;
      
      const ncList = getNC();
      const nc = ncList.find(n => n.numero === numero);
      if (nc) {
        nc.statut = 'ClÃ´turÃ©e';
        nc.dateCloture = new Date().toISOString();
        saveNC(ncList);
        afficherNC();
        alert(`âœ… NC ${numero} clÃ´turÃ©e`);
      }
    }

    // Filtrer les NC
    function filtrerNC(filter) {
      afficherNC(filter);
    }

    // Exporter les NC
    function exporterNC() {
      const ncList = getNC();
      if (ncList.length === 0) {
        alert('Aucune NC Ã  exporter');
        return;
      }
      
      let texte = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
      texte += '  REGISTRE DES NON-CONFORMITÃ‰S PMS\n';
      texte += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
      texte += `Date d'export : ${new Date().toLocaleDateString('fr-FR')}\n\n`;
      
      ncList.forEach(nc => {
        texte += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
        texte += `${nc.numero} - ${nc.statut}\n`;
        texte += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
        texte += `Date : ${nc.date}\n`;
        texte += `Type : ${nc.type}\n`;
        texte += `GravitÃ© : ${nc.gravite}\n`;
        texte += `Description : ${nc.description}\n`;
        texte += `Cause : ${nc.cause || '-'}\n`;
        texte += `Action immÃ©diate : ${nc.actionImmediate}\n`;
        texte += `Action corrective : ${nc.actionCorrective}\n`;
        texte += `Responsable : ${nc.responsable}\n`;
        texte += `Ã‰chÃ©ance : ${nc.echeance}\n`;
        texte += `DÃ©tectÃ© par : ${nc.detecteur}\n\n`;
      });
      
      texte += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
      texte += 'GRETA du Var / GIP FIPAN\n';
      texte += 'AcadÃ©mie de Nice\n';
      texte += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
      
      const blob = new Blob([texte], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Registre_NC_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Afficher au chargement
    afficherNC();
    
    // DÃ©finir la date du jour par dÃ©faut
    document.getElementById('ncDate').valueAsDate = new Date();
  </script>

</body>
</html>
